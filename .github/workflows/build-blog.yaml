# 编译二进制
name: Build Binary

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      branch:
        description: '指定要打包的分支 main'
        required: false
        default: 'main'
        type: string
      release_tag:
        description: 'Release版本Tag（如v1.0.0，为空则仅保存产物不上传Release）'
        default: 'v0.0.1'
        required: false
        type: string
env:
  HUSKY: '0'
  BINARY_NAME: "blogGo"

jobs:
  build-go-binary:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, windows, darwin] # 需要打包的系统
        goarch: [amd64, arm64] # 需要打包的架构
        exclude: # 排除某些平台和架构
          - goarch: arm64
            goos: windows
    steps:
      # 拉取代码
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          # 拉取手动指定的分支
          ref: ${{ github.event.inputs.branch }}

      # 工具默认不会自动创建 Tag/Release，只能往「已存在的 Release（绑定对应 Tag）」上传产物
      - name: build
        uses: wangyoucao577/go-release-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }} # 一个默认的变量，用来实现往 Release 中添加文件
          goos: ${{ matrix.goos }}
          goarch: ${{ matrix.goarch }}
          # 可以指定编译使用的 Golang 版本
          goversion: "https://golang.google.cn/dl/go1.26.0.linux-amd64.tar.gz"
          binary_name: ${{ env.BINARY_NAME }} # 可以指定二进制文件的名称
          build_flags: "-a"
          ldflags: '-extldflags "-static"'
          # 仅当填写了release_tag时，才上传到Release（避免Tag缺失报错）
          release_tag: ${{ github.event.inputs.release_tag }}
          release_name: ${{ github.event.inputs.release_tag }}
          overwrite: true  # 覆盖同名Tag的Release产物
          # 项目目录
          #project_path: "./cmd/test-binary"
          #extra_files: README.md config.dev.json # 需要包含的额外文件
          #是否上传产物到 Release（默认 true）；
          #设为 false 时，仅编译不上传，留给后续步骤处理（如签名）
          upload: true

      - name: List
        run: ls -R ./